# Maintainer: Remisa Yousefvand <remisa.yousefvand@gmail.com>
# Needs revision

pkgname=secret-service
pkgver=0.1.0
pkgrel=1
pkgdesc="secret service provides secure ways of storing credentials"
arch=('i686' 'pentium4' 'x86_64' 'arm' 'armv7h' 'armv6h' 'aarch64')
url="https://github.com/yousefvand/secret-service"
license=('MIT')
groups=()
depends=(
#  'wmctrl'
)
makedepends=('git' 'go')
optdepends=('sudo')
provides=()
conflicts=()
replaces=()
backup=()
options=()
install=
changelog=
source=("$pkgname-$pkgver.tar.gz::$url/archive/v${pkgver}.tar.gz")
noextract=()
md5sums=() #autofill using updpkgsums
sha256sums=('???')

prepare() {
  export GOPATH="$srcdir"/gopath
  # go clean -modcache
}

build() {
  cd "$pkgname-$pkgver"
  go build -o secretserviced cmd/app/secretserviced/main.go
}

package() {
  cd "$pkgname-$pkgver"
    install -Dm755 "$pkgname" "$pkgdir/usr/bin/$pkgname"

if ! [ -f "/etc/systemd/user/secretserviced.service" ]; then
  password=$(tr -dc A-Za-z0-9 </dev/urandom | head -c 32 ; echo '')
  cat << EOF | sudo tee "/etc/systemd/user/secretserviced.service" >/dev/null
[Unit]
Description=Service to keep secrets of applications
Documentation=https://github.com/yousefvand/secret-service

[Install]
WantedBy=default.target

[Service]
Type=simple
RestartSec=30
Restart=always
Environment="MASTERPASSWORD=$password"
WorkingDirectory=/usr/bin/
ExecStart=/usr/bin/secretserviced
EOF
fi
}
